---
import { getImage } from "astro:assets";
import BaseLayout from "../layouts/BaseLayout.astro";
import resume from "../content/resume.json";
import popoversRaw from "../content/popovers.json";
import { renderHotspots } from "../utils/render";
import type { Education, PopoverData } from "../types/content";
import "../styles/global.css";

import { optimizePopoverImages } from "../utils/images";

// ── Image Optimization Pipeline ──────────────────────────────────────────────
// Pre-optimise all images in the popover inventory at build time.
// This swaps raw /public paths for optimized, content-hashed WebP assets.

const popovers = await optimizePopoverImages(popoversRaw, getImage);
---

<BaseLayout
  title={resume.displayName}
  description="Design leadership — KC Wolff-Ingham. Senior product design leader with 30 years spanning banking, health tech, and media."
>
  <!-- ═══════ HERO ═══════ -->
  <header class="hero">
    <h1 class="hero-name">{resume.displayName}</h1>
    <div class="hero-rule"></div>
    <p class="hero-sub">{resume.hero.tagline}</p>
    <div class="hero-credentials">
      {
        resume.hero.credentials.map((c, i) => (
          <>
            {i > 0 && <span aria-hidden="true">·</span>}
            {c}
          </>
        ))
      }
    </div>
  </header>

  <!-- ═══════ THE DOCUMENT ═══════ -->
  <main class="doc-wrapper" id="main-content">
    <section class="doc-page reveal" aria-label="Resume Content">
      <div class="doc-hint">
        <span class="doc-hint-dot" aria-hidden="true"></span> Highlighted items are
        interactive
      </div>

      <!-- Header -->
      <div class="doc-name">{resume.name}</div>
      <div class="doc-title-line">{resume.titleLine}</div>
      <div class="doc-contact">
        <a href={`mailto:${resume.contact.email}`}>{resume.contact.email}</a> &nbsp;·&nbsp;
        {resume.contact.phone} &nbsp;·&nbsp;
        <a href={resume.contact.linkedinUrl} target="_blank"
          >{resume.contact.linkedin}</a
        > &nbsp;·&nbsp;
        {resume.contact.location}
      </div>
      <hr class="doc-hr" />

      <!-- Executive Summary -->
      {
        resume.summary
          .split("\n\n")
          .map((para) => (
            <div class="doc-summary" set:html={renderHotspots(para)} />
          ))
      }

      <!-- Key Achievements -->
      <div class="doc-section-heading">Key Achievements</div>

      {
        resume.keyAchievements.map((cluster) => (
          <div class="doc-achievement-cluster">
            <h4>{cluster.heading}</h4>
            <ul>
              {cluster.items.map((item) => (
                <li set:html={renderHotspots(item)} />
              ))}
            </ul>
          </div>
        ))
      }

      <hr class="doc-hr-thin" />

      <!-- Experience -->
      <div class="doc-section-heading">Experience</div>

      {
        resume.experience.map((job) => (
          <div class="doc-exp">
            <div class="doc-exp-header">
              <span class="doc-exp-company">{job.company}</span>
              <span class="doc-exp-dates">{job.dates}</span>
            </div>
            <div class="doc-exp-title">{job.title}</div>
            {job.description && (
              <div
                class="doc-exp-desc"
                set:html={renderHotspots(job.description)}
              />
            )}
            <ul>
              {job.bullets.map((bullet) => (
                <li set:html={renderHotspots(bullet)} />
              ))}
            </ul>
          </div>
        ))
      }

      <hr class="doc-hr-thin" />

      <!-- Education -->
      <div class="doc-section-heading">Education</div>

      {
        (resume.education as Education[]).map((edu) => (
          <div class="doc-edu-item">
            <div class="degree">{edu.degree}</div>
            <div class="school">{edu.school}</div>
            {edu.focus && (
              <div class="focus" set:html={renderHotspots(edu.focus)} />
            )}
          </div>
        ))
      }

      <hr class="doc-hr-thin" />

      <!-- Patents & Recognition -->
      <div class="doc-section-heading">Patents &amp; Recognition</div>
      <div class="doc-awards-line">
        <strong>Patents:</strong>
        {resume.patentsAndRecognition.patents}
      </div>
      <div class="doc-awards-line">
        <strong>Awards:</strong>
        {resume.patentsAndRecognition.awards}
      </div>
      <div class="doc-awards-line">
        <strong>Certifications:</strong>
        {resume.patentsAndRecognition.certifications}
      </div>

      <!-- Page footer -->
      <div class="doc-footer">
        {resume.displayName} &nbsp;·&nbsp; {resume.contact.email} &nbsp;·&nbsp; {
          resume.contact.phone
        } &nbsp;·&nbsp; {resume.contact.location}
      </div>
    </section>
  </main>

  <!-- ═══════ POPOVER OVERLAY ═══════ -->
  <div class="popover-overlay" id="popover-overlay" role="presentation"></div>
  <div
    class="popover"
    id="popover"
    role="dialog"
    aria-modal="true"
    aria-label="Details"
    tabindex="-1"
  >
  </div>

  <div class="site-footer">
    <p>&copy; 2026 {resume.displayName}</p>
  </div>

  <!-- Discovery Hint (Desktop, < 1400px) -->
  <div id="widen-hint" class="widen-hint" role="presentation">
    <div class="widen-side left">
      <!-- Left side: horizontal run from X=0 to 180, corner 180 to 200, vertical run UP from 400 to 0 -->
      <svg class="widen-svg text-left" viewBox="0 0 200 400">
        <path
          id="widen-path-left"
          d="M0,400 L180,400 Q200,400 200,380 L200,0"
          fill="none"
          stroke="none"></path>
        <text class="widen-text">
          <textPath
            id="widen-textpath-left"
            href="#widen-path-left"
            text-anchor="start"
          >
            <tspan class="chevron chevron-left">&lt;&lt; </tspan><tspan
              id="widen-label-left">Expand window</tspan
            >
          </textPath>
        </text>
      </svg>
    </div>
    <div class="widen-side right">
      <!-- Right side: vertical run DOWN from 0 to 380, corner 380 to 400, horizontal run RIGHT to 200 -->
      <svg class="widen-svg text-right" viewBox="0 0 200 400">
        <path
          id="widen-path-right"
          d="M0,0 L0,380 Q0,400 20,400 L200,400"
          fill="none"
          stroke="none"></path>
        <text class="widen-text">
          <textPath
            id="widen-textpath-right"
            href="#widen-path-right"
            text-anchor="start"
          >
            <tspan id="widen-label-right">For marginalia</tspan><tspan
              class="chevron chevron-right"
            >
              &gt;&gt;</tspan
            >
          </textPath>
        </text>
      </svg>
    </div>
  </div>

  <!-- ═══════ PAGE DATA → window globals ═══════ -->
  <!-- define:vars safely serialises build-time data; no template literals used here -->
  <script define:vars={{ popovers }}>
    window.__POPOVERS__ = popovers;
  </script>

  <!-- ═══════ CLIENT-SIDE JS (module) ═══════ -->
  <script>
    import "../scripts/main.ts";
  </script>
</BaseLayout>
